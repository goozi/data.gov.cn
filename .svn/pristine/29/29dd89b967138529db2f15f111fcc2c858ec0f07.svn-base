package com.dhccity.data.servlet;

import java.io.*;
import java.math.BigDecimal;
import java.text.NumberFormat;
import java.util.*;
import javax.servlet.*;
import javax.servlet.http.*;

import com.dhccity.base.util.BaseConstant;
import org.light.*;
import com.dhccity.data.entity.Dataset;

/**
 * <p>
 * Title: Dataset对象管理Servlet类
 * </p>
 * <p>
 * Description:
 * </p>
 * :);
 * <p>
 * Company: Kingtop
 * </p>
 * <p>
 * CreateDate: 2015-05-14 16:07:19
 * </p>
 *
 * @author Zerrion
 * @version 1.0
 */
public class DatasetAction extends ServletAction implements BaseConstant {
    private final String SYSTEM_NAME = "数据";
    private final String MODULE_NAME = "数据集";
    private final int WINDOW_TYPE = 1; // 0表示无效、1表示调转、2表示关闭

    /**
     * 增加一条数据
     */
    public void addData(HttpRequest request, HttpServletResponse response,
                        User user) throws ServletException, IOException {
        String flow = request.getString("flow");
        String name = request.getString("name");
        String title = request.getString("title");
        String description = request.getString("description");
        //int state = request.getInt("state");
        String isPublic = request.getString("isPublic");
        //long creator = request.getLong("creator");
        //Date createTime = request.getDate("createTime");
        //long modifyUser = request.getLong("modifyUser");
        //Date modifyTime = request.getDate("modifyTime");
        String updateRate = request.getString("updateRate");
        //long downloadNum = request.getLong("downloadNum");
        //long readNum = request.getLong("readNum");
        long orgId = request.getLong("orgId");
        long groupId = request.getLong("groupId");

        Date now = new Date();

        // 新建一个对象
        Dataset dataset = new Dataset();
        dataset.setName(name);
        dataset.setTitle(title);
        dataset.setDescription(description);
        dataset.setState(STATE_NORMAL);
        dataset.setIsPublic(isPublic);
        dataset.setCreator(user.getId());
        dataset.setCreateTime(now);
        dataset.setModifyUser(user.getId());
        dataset.setModifyTime(now);
        dataset.setUpdateRate(updateRate);
        //dataset.setDownloadNum(downloadNum);
        //dataset.setReadNum(readNum);
        dataset.setOrgId(orgId);
        dataset.setGroupId(groupId);
        dataset.add(); // 增加记录

        user.addLog(SYSTEM_NAME, MODULE_NAME, "增加记录[" + dataset.getId() + "]");
        if ("single".equals(flow)) {
            doReturn(response, WINDOW_TYPE, "dataset_list.jsp");
        } else if ("multi".equals(flow)) {
            doReturn(response, WINDOW_TYPE,
                    "dataResource_add.jsp?datasetId=" + dataset.getId());
        }
    }

    /**
     * 修改指定数据
     */
    public void updateData(HttpRequest request, HttpServletResponse response,
                           User user) throws ServletException, IOException {
        long id = request.getLong("id");
        String name = request.getString("name");
        String title = request.getString("title");
        String description = request.getString("description");
        //int state = request.getInt("state");
        String isPublic = request.getString("isPublic");
        //long creator = request.getLong("creator");
        //Date createTime = request.getDate("createTime");
        //long modifyUser = request.getLong("modifyUser");
        //Date modifyTime = request.getDate("modifyTime");
        String updateRate = request.getString("updateRate");
        //long downloadNum = request.getLong("downloadNum");
        //long readNum = request.getLong("readNum");
        long orgId = request.getLong("orgId");
        long groupId = request.getLong("groupId");

        Date now = new Date();
        // 新建一个对象
        Dataset dataset = (Dataset) new Dataset().findById(id);
        dataset.setId(id);
        dataset.setName(name);
        dataset.setTitle(title);
        dataset.setDescription(description);
        //dataset.setState(state);
        dataset.setIsPublic(isPublic);
        //dataset.setCreator(user.getId());
        //dataset.setCreateTime(now);
        dataset.setModifyUser(user.getId());
        dataset.setModifyTime(now);
        dataset.setUpdateRate(updateRate);
        //dataset.setDownloadNum(downloadNum);
        //dataset.setReadNum(readNum);
        dataset.setOrgId(orgId);
        dataset.setGroupId(groupId);
        dataset.update(); // 修改记录

        user.addLog(SYSTEM_NAME, MODULE_NAME, "修改记录[]");
        doReturn(response, WINDOW_TYPE, "dataset_list.jsp");
    }

    /**
     * 删除数据
     */
    public void deleteData(HttpRequest request, HttpServletResponse response,
                           User user) throws ServletException, IOException {
        long[] idArray = request.getLongArray("idArray");
        String log = "";

        // 新建一个对象
        Dataset dataset = new Dataset();
        if (idArray != null) {
            for (int i = 0; i < idArray.length; i++) {
                dataset.delete(idArray[i]); // 删除记录
                log += idArray[i] + ";";
            }
        }

        user.addLog(SYSTEM_NAME, MODULE_NAME, "删除记录[" + log + "]");
    }

    /**
     * 更新下载数
     */
    public void updateDownloadNum(HttpRequest request, HttpServletResponse response, User user) throws ServletException, IOException {
        long id = request.getLong("id");
        Dataset dataset = (Dataset) new Dataset().findById(id);
        dataset.setDownloadNum(dataset.getDownloadNum() + 1);
        dataset.update();

        PrintWriter out = response.getWriter();
        out.print("success");
    }

    /**
     * 更新阅读数
     */
    public void updateReadNum(HttpRequest request, HttpServletResponse response, User user) throws ServletException, IOException {
        long id = request.getLong("id");
        Dataset dataset = (Dataset) new Dataset().findById(id);
        dataset.setReadNum(dataset.getReadNum() + 1);
        dataset.update();

        PrintWriter out = response.getWriter();
        out.print("success");
    }

    /**
     * 评分
     */
    public void updateStars(HttpRequest request, HttpServletResponse response, User user) throws ServletException, IOException {
        long id = request.getLong("id");
        int star = request.getInt("star");
        Dataset dataset = (Dataset) new Dataset().findById(id);
        double stars = (dataset.getStars() * dataset.getMark_num() + star) / (dataset.getMark_num() + 1);
        BigDecimal b = new BigDecimal(stars);
        dataset.setStars(b.setScale(3, BigDecimal.ROUND_HALF_UP).floatValue());
        dataset.setMark_num(dataset.getMark_num()+1);
        dataset.update();

        PrintWriter out = response.getWriter();
        out.print("success");
    }
}
